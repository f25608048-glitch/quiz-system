<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Portal - Smart Quiz System</title>
    <!-- Google Fonts: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #2563eb;
            /* Royal Blue */
            --primary-dark: #1e40af;
            --bg-body: #f8fafc;
            --bg-card: #ffffff;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --border-color: #e2e8f0;
            --success: #10b981;
            --danger: #ef4444;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Navbar */
        .navbar {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-sm);
        }

        .logo {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .user-info {
            font-size: 0.9rem;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .btn-logout {
            background: #fee2e2;
            color: #b91c1c;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            text-decoration: none;
            font-weight: 600;
            font-size: 0.85rem;
            border: 1px solid #fecaca;
            transition: all 0.2s;
            cursor: pointer;
        }

        .btn-logout:hover {
            background: #fecaca;
        }

        /* Auth Screen */
        #authScreen {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem;
        }

        .auth-card {
            background: var(--bg-card);
            padding: 2.5rem;
            border-radius: 1rem;
            box-shadow: var(--shadow-md);
            width: 100%;
            max-width: 400px;
            border: 1px solid var(--border-color);
            text-align: center;
        }

        .auth-card h2 {
            margin-bottom: 1.5rem;
            color: var(--text-main);
        }

        input {
            width: 100%;
            padding: 0.75rem;
            margin-bottom: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            font-family: inherit;
            background: #f8fafc;
        }

        input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: none;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: background 0.2s;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        /* Dashboard */
        .dashboard-container {
            display: none;
            padding: 2rem;
            max-width: 1000px;
            margin: 0 auto;
            width: 100%;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: var(--text-main);
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 0.5rem;
        }

        .grid-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        .card {
            background: var(--bg-card);
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
        }

        /* Exam View */
        #quizArea {
            display: none;
            max-width: 800px;
            margin: 2rem auto;
            background: var(--bg-card);
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: var(--shadow-md);
        }

        .timer {
            font-size: 1.25rem;
            color: #d97706;
            /* Amber */
            font-weight: 700;
            text-align: right;
            margin-bottom: 1.5rem;
        }

        .q-block {
            background: #f8fafc;
            padding: 1.5rem;
            border-radius: 0.75rem;
            margin-bottom: 1.5rem;
            border-left: 4px solid var(--primary);
            border: 1px solid var(--border-color);
        }

        .opt-label {
            display: block;
            background: white;
            padding: 0.75rem;
            margin: 0.5rem 0;
            border-radius: 0.5rem;
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: 0.2s;
        }

        .opt-label:hover {
            border-color: var(--primary);
            background: #eff6ff;
        }

        textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            min-height: 100px;
            resize: vertical;
        }

        /* History List */
        .history-item {
            background: #f8fafc;
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid var(--border-color);
            margin-bottom: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .score-pill {
            background: var(--primary);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 999px;
            font-weight: 600;
            font-size: 0.85rem;
        }

        /* Cheating Warning */
        #cheatOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(220, 38, 38, 0.95);
            z-index: 99999;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: white;
            text-align: center;
        }

        .cheat-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }
    </style>
</head>

<body>

    <!-- Cheating Overlay -->
    <div id="cheatOverlay">
        <div class="cheat-icon">ðŸš«</div>
        <h1>EXAM BLOCKED!</h1>
        <p>Tab switch detected. This is considered cheating.</p>
        <p style="margin-top: 20px;">Exam auto-submitted.</p>
        <button onclick="location.reload()"
            style="background:white; color:#dc2626; border:none; padding:10px 20px; font-weight:bold; margin-top:20px; cursor:pointer;">Close</button>
    </div>

    <!-- Navbar -->
    <nav class="navbar" id="navbar" style="display: none;">
        <a href="#" class="logo">
            <span>ðŸŽ“ Student Portal</span>
        </a>
        <div class="user-info">
            <span id="navUserInfo"></span>
            <button class="btn-logout" onclick="logout()">Logout</button>
        </div>
    </nav>

    <!-- Auth Screen -->
    <div id="authScreen">
        <div class="auth-card">
            <h2>Student Login</h2>
            <input type="text" id="sName" placeholder="Full Name">
            <input type="text" id="sRoll" placeholder="Roll Number (e.g. 101)">
            <input type="email" id="sEmail" placeholder="Gmail Address">
            <input type="password" id="sPass" placeholder="Password (create new or login)">

            <button class="btn-primary" onclick="handleAuth()">Access Portal</button>
        </div>
    </div>

    <!-- Dashboard -->
    <div class="dashboard-container" id="dashboard">
        <div class="grid-layout">
            <!-- Join Exam -->
            <div class="card">
                <h3 class="section-title">ðŸš€ Join Exam</h3>
                <p style="color:var(--text-muted); margin-bottom:1rem;">Enter your Teacher's ID to start a live exam.
                </p>
                <input type="text" id="teacherID" placeholder="Teacher's Username (e.g. T-101)">
                <button class="btn-primary" onclick="joinExam()">Start Exam Now</button>
            </div>

            <!-- History -->
            <div class="card">
                <h3 class="section-title">ðŸ“œ My Results History</h3>
                <div id="historyList">
                    <p style="text-align:center; color:var(--text-muted);">No exams taken yet.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Live Exam Area -->
    <div id="quizArea">
        <div class="timer" id="timerDisplay">Time Left: 10:00</div>
        <div id="questionContent"></div>
        <button class="btn-primary" onclick="submitExam()" style="margin-top:2rem; background:var(--success);">âœ… Submit
            Final Exam</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, get, set, child } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBOVvfW63xx10C4_l9obcQMC64cDFGndZ8",
            authDomain: "smart-quiz-system-d59d9.firebaseapp.com",
            databaseURL: "https://smart-quiz-system-d59d9-default-rtdb.firebaseio.com",
            projectId: "smart-quiz-system-d59d9",
            storageBucket: "smart-quiz-system-d59d9.firebasestorage.app",
            messagingSenderId: "38603211706",
            appId: "1:38603211706:web:57b1e7a3d48426544ad383"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        let currentUser = null;
        let rollNumber = "";
        let studentName = "";
        let currentTeacherID = "";
        let examData = null;
        let timerInterval = null;
        let timeLeft = 600;
        let isExamActive = false;

        // Auth Observer
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // Restore profile
                const savedRoll = localStorage.getItem('sRoll');
                const savedName = localStorage.getItem('sName');
                if (savedRoll) {
                    showDashboard(user, savedRoll, savedName);
                }
            }
        });

        window.handleAuth = () => {
            const email = document.getElementById('sEmail').value;
            const pass = document.getElementById('sPass').value;
            const roll = document.getElementById('sRoll').value;
            const name = document.getElementById('sName').value;

            if (!email || !pass || !roll) return alert("Fill all fields!");

            signInWithEmailAndPassword(auth, email, pass)
                .then((uc) => {
                    localStorage.setItem('sRoll', roll);
                    localStorage.setItem('sName', name); // Might be empty on login, ideally fetch profile
                    showDashboard(uc.user, roll, name);
                })
                .catch(() => {
                    createUserWithEmailAndPassword(auth, email, pass)
                        .then((uc) => {
                            localStorage.setItem('sRoll', roll);
                            localStorage.setItem('sName', name);
                            showDashboard(uc.user, roll, name);
                        })
                        .catch(e => alert(e.message));
                });
        };

        function showDashboard(user, roll, name) {
            currentUser = user;
            rollNumber = roll;
            studentName = name || "Student";

            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            document.getElementById('navbar').style.display = 'flex';
            document.getElementById('navUserInfo').innerText = `${studentName} (Roll: ${roll})`;

            loadHistory();
        }

        window.logout = () => {
            signOut(auth);
            localStorage.clear();
            location.reload();
        };

        window.joinExam = async () => {
            const tID = document.getElementById('teacherID').value.trim().toLowerCase();
            if (!tID) return alert("Enter Teacher ID!");

            try {
                const snap = await get(ref(db, `exams/${tID}`));
                if (!snap.exists()) return alert("No Exam Found!");

                examData = snap.val();

                // Check allowed list
                if (examData.allowedList && !examData.allowedList.includes(rollNumber)) {
                    return alert("You are NOT allowed for this exam!");
                }

                currentTeacherID = tID;
                startExamUI();

            } catch (e) { alert(e.message); }
        };

        function startExamUI() {
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('quizArea').style.display = 'block';

            // Render Questions
            const container = document.getElementById('questionContent');
            container.innerHTML = "";

            examData.questions.forEach((q, i) => {
                let html = `<div class="q-block">
                    <h3>Q${i + 1}: ${q.text}</h3>`;

                if (q.type === 'mcq') {
                    for (let key in q.options) {
                        html += `
                        <label class="opt-label">
                            <input type="radio" name="q${i}" value="${key}"> 
                            <strong>${key})</strong> ${q.options[key]}
                        </label>`;
                    }
                } else {
                    html += `<textarea id="ans${i}" placeholder="Type your answer here..."></textarea>`;
                }
                html += `</div>`;
                container.innerHTML += html;
            });

            isExamActive = true;
            timeLeft = 600; // 10 mins default
            startTimer();
            enableSecurity();
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                timeLeft--;
                let m = Math.floor(timeLeft / 60);
                let s = timeLeft % 60;
                document.getElementById('timerDisplay').innerText = `Time Left: ${m}:${s < 10 ? '0' + s : s}`;
                if (timeLeft <= 0) submitExam();
            }, 1000);
        }

        // Security Features
        function enableSecurity() {
            document.addEventListener("visibilitychange", () => {
                if (document.hidden && isExamActive) {
                    forceSubmitCheating();
                }
            });
            window.onblur = () => {
                if (isExamActive) forceSubmitCheating();
            };
        }

        async function forceSubmitCheating() {
            isExamActive = false;
            clearInterval(timerInterval);
            document.getElementById('cheatOverlay').style.display = 'flex';
            await submitLogic(true); // true = cheated
        }

        window.submitExam = async () => {
            if (!isExamActive) return;
            isExamActive = false;
            clearInterval(timerInterval);
            await submitLogic(false);
            alert("Exam Submitted Successfully!");
            location.reload();
        };

        async function submitLogic(cheated) {
            let score = 0;
            let total = examData.questions.length;
            let answers = {};

            examData.questions.forEach((q, i) => {
                if (q.type === 'mcq') {
                    const sel = document.querySelector(`input[name="q${i}"]:checked`)?.value;
                    const isCorrect = sel === q.correct;
                    if (isCorrect) score++;
                    answers[`q${i}`] = {
                        question: q.text,
                        type: 'mcq',
                        selected: sel || 'Not Answered',
                        correct: q.correct,
                        isCorrect: isCorrect
                    };
                } else {
                    const ans = document.getElementById(`ans${i}`).value;
                    answers[`q${i}`] = {
                        question: q.text,
                        type: 'subjective',
                        answer: ans,
                        manualScore: 0 // Waiting for teacher
                    };
                }
            });

            const finalPercentage = Math.round((score / total) * 100);

            // Save to Teacher's Submissions
            await set(ref(db, `exams/${currentTeacherID}/submissions/${rollNumber}`), {
                name: studentName,
                email: currentUser.email,
                score: finalPercentage, // Initial MCQ score
                answers: answers,
                cheated: cheated,
                time: new Date().toISOString()
            });

            // Save to Student History (using safe email key)
            // Note: Student History is best fetched directly from submissions if teacher is known, 
            // OR we save a redundant copy here. For simplicity, we save a copy.
            const safeEmail = currentUser.email.replace(/\./g, '_');
            await set(ref(db, `student-history/${safeEmail}/${Date.now()}`), {
                teacherID: currentTeacherID,
                score: finalPercentage,
                date: new Date().toLocaleDateString(),
                status: cheated ? 'Cheated' : 'Submitted'
            });
        }

        async function loadHistory() {
            // Fetch history from Student-History node
            // Note: This only shows exams taken by this email
            const safeEmail = currentUser.email.replace(/\./g, '_');
            const snap = await get(ref(db, `student-history/${safeEmail}`));
            const list = document.getElementById('historyList');

            if (snap.exists()) {
                list.innerHTML = "";
                const data = snap.val();
                Object.values(data).forEach(exam => {
                    list.innerHTML += `
                    <div class="history-item">
                        <div>
                            <strong>Exam ID: ${exam.teacherID}</strong>
                            <div style="font-size:0.8rem; color:var(--text-muted);">${exam.date}</div>
                        </div>
                        <span class="score-pill">${exam.score}%</span>
                    </div>`;
                });
            }
        }
    </script>
</body>

</html>
