<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Student Portal - Authorized Only</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #1a1a2e; color: white; text-align: center; padding: 50px; }
        .card { background: #16213e; padding: 30px; border-radius: 15px; display: inline-block; width: 350px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 5px; border: none; box-sizing: border-box; }
        button { background: #e94560; color: white; border: none; padding: 15px; width: 100%; border-radius: 5px; cursor: pointer; font-weight: bold; }
        #quizArea { display: none; text-align: left; max-width: 600px; margin: auto; }
        .timer { font-size: 1.5rem; color: #e94560; font-weight: bold; margin-bottom: 20px; }
    </style>
</head>
<body>

<div id="loginArea" class="card">
    <h2>üìù Student Login</h2>
    <input type="text" id="studentReg" placeholder="Enter Registration Number">
    <button onclick="attemptEntry()">ENTER EXAM HALL</button>
</div>

<div id="quizArea">
    <div class="timer" id="timer">Time Remaining: --:--</div>
    <div id="questionContent"></div>
    <button onclick="submitExam()" id="submitBtn" style="margin-top:20px; background:#2ed573;">SUBMIT TEST</button>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyB0VvfW63xx10C4_l9obcQMC64cDFGndZ8",
        authDomain: "smart-quiz-system-d59d9.firebaseapp.com",
        databaseURL: "https://smart-quiz-system-d59d9-default-rtdb.firebaseio.com",
        projectId: "smart-quiz-system-d59d9",
        storageBucket: "smart-quiz-system-d59d9.firebasestorage.app",
        messagingSenderId: "38603211706",
        appId: "1:38603211706:web:57b1e7a3d48426544ad383"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    let examData = null;
    let cheated = false;

    onValue(ref(db, 'activeExam'), (snap) => {
        examData = snap.val();
    });

    window.attemptEntry = () => {
        const reg = document.getElementById('studentReg').value;
        if(!examData) return alert("Teacher has not started any exam yet!");
        
        if(examData.allowedList && examData.allowedList.includes(reg)) {
            document.getElementById('loginArea').style.display = 'none';
            document.getElementById('quizArea').style.display = 'block';
            loadQuestions();
            startTimer();
        } else {
            alert("‚ùå Your registration number is not authorized for this test!");
        }
    };

    function loadQuestions() {
        const container = document.getElementById('questionContent');
        examData.questions.forEach((q, i) => {
            let html = `<div style="margin-bottom:20px;"><h3>Q${i+1}: ${q.text}</h3>`;
            if(q.type === 'mcq') {
                for(let opt in q.options) {
                    html += `<label><input type="radio" name="q${i}" value="${opt}"> ${q.options[opt]}</label><br>`;
                }
            } else {
                html += `<textarea id="ans${i}" style="width:100%; height:80px;"></textarea>`;
            }
            container.innerHTML += html + `</div>`;
        });
    }

    function startTimer() {
        const interval = setInterval(() => {
            const timeLeft = Math.floor((examData.endTime - Date.now()) / 1000);
            if(timeLeft <= 0) { clearInterval(interval); submitExam(); }
            document.getElementById('timer').innerText = `Time Remaining: ${Math.floor(timeLeft/60)}:${timeLeft%60}`;
        }, 1000);
    }

    // Anti-Cheat (Tab Switch Detection)
    window.onblur = () => { cheated = true; alert("üö® Warning: Tab switching detected! This will be reported."); };

    window.submitExam = () => {
        let score = 0;
        examData.questions.forEach((q, i) => {
            if(q.type === 'mcq') {
                const selected = document.querySelector(`input[name="q${i}"]:checked`)?.value;
                if(selected === q.correct) score++;
            } else {
                score++; // Subjective markers placeholder
            }
        });
        const finalScore = Math.round((score / examData.questions.length) * 100);
        set(ref(db, 'submissions/' + document.getElementById('studentReg').value), {
            name: document.getElementById('studentReg').value,
            score: finalScore,
            cheated: cheated
        });
        alert("Exam Submitted Successfully!");
        location.reload();
    };
</script>
</body>
</html>
