<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Student Portal - Online Exam</title>
    <style>
        /* ===== THEME VARIABLES (Laiba's Logic) ===== */
        :root {
            --bg-color: #f1f5f9;
            --card-bg: #ffffff;
            --text-color: #0f172a;
            --input-bg: #e2e8f0;
            --button-bg: #10b981;
            --q-block-bg: #ffffff;
            --opt-bg: #f8fafc;
            --modal-bg: rgba(0, 0, 0, 0.7);
        }

        [data-theme="dark"] {
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --text-color: #ffffff;
            --input-bg: #334155;
            --button-bg: #3b82f6;
            --q-block-bg: #0f172a;
            --opt-bg: #1e293b;
            --modal-bg: rgba(0, 0, 0, 0.85);
        }

        /* ===== STYLING ===== */
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: var(--bg-color); 
            color: var(--text-color); 
            margin: 0; 
            min-height: 100vh; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            transition: 0.3s;
        }

        .card { 
            background: var(--card-bg); 
            padding: 35px; 
            border-radius: 15px; 
            width: 350px; 
            text-align: center; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); 
        }

        input, select, textarea { 
            width: 100%; 
            padding: 12px; 
            margin: 10px 0; 
            border-radius: 6px; 
            border: 1px solid #ccc; 
            box-sizing: border-box; 
            background: var(--input-bg); 
            color: var(--text-color);
        }

        button { 
            background: var(--button-bg); 
            color: white; 
            border: none; 
            padding: 15px; 
            width: 100%; 
            border-radius: 6px; 
            cursor: pointer; 
            font-weight: bold; 
            margin-top: 10px; 
        }

        /* Quiz Area */
        #quizArea { 
            display: none; 
            width: 90%; 
            max-width: 800px; 
            background: var(--card-bg); 
            padding: 30px; 
            border-radius: 15px; 
            margin: 20px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .timer { font-size: 1.5rem; color: #fbbf24; font-weight: bold; text-align: right; }

        .q-block { 
            background: var(--q-block-bg); 
            padding: 20px; 
            margin-bottom: 15px; 
            border-radius: 10px; 
            border-left: 5px solid #3b82f6; 
        }

        .opt-label { 
            display: block; 
            background: var(--opt-bg); 
            padding: 10px; 
            margin: 5px 0; 
            border-radius: 5px; 
            cursor: pointer; 
        }

        /* Hafsa's Report Modal Styling */
        .modal-overlay {
            display: none; 
            position: fixed; 
            top: 0; left: 0; 
            width: 100%; height: 100%; 
            background: var(--modal-bg); 
            z-index: 1000; 
            justify-content: center; 
            align-items: center;
        }
        .modal-content {
            background: var(--card-bg); 
            padding: 25px; 
            border-radius: 12px; 
            width: 90%; 
            max-width: 400px; 
            border: 1px solid #3b82f6;
            color: var(--text-color);
        }

        #themeBtn {
            position: fixed; top: 20px; right: 20px;
            padding: 10px 15px; border-radius: 8px; border: none;
            background: var(--button-bg); color: white; cursor: pointer; font-weight: bold;
        }
    </style>
</head>
<body>

<button id="themeBtn">üåô Dark Mode</button>

<div id="loginArea" class="card">
    <h2>üë®‚Äçüéì Student Entry</h2>
    <input type="email" id="sEmail" placeholder="Gmail Address">
    <input type="password" id="sPass" placeholder="Password">
    <input type="text" id="teacherID" placeholder="Teacher's Username">
    <input type="text" id="studentReg" placeholder="Roll Number">
    <button onclick="attemptEntry()">START EXAM</button>
</div>

<div id="quizArea">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <button onclick="toggleModal(true)" style="background: #f59e0b; width: auto; padding: 10px 20px;">‚ö†Ô∏è Report Issue</button>
        <div class="timer" id="timerDisplay">Time Left: 10:00</div>
    </div>
    <div id="questionContent"></div>
    <button onclick="submitExam()" style="background:#3b82f6; margin-top: 30px;">SUBMIT FINAL TEST ‚úÖ</button>
</div>

<div id="reportModal" class="modal-overlay">
    <div class="modal-content">
        <span style="float:right; cursor:pointer; font-size:24px;" onclick="toggleModal(false)">&times;</span>
        <h3>üì¢ Report Issue</h3>
        <label>Question Number</label>
        <input type="number" id="reportQNum" placeholder="e.g. 5">
        <label>Reason</label>
        <select id="reportReason">
            <option value="Wrong Answer">Wrong Answer Key</option>
            <option value="Typo">Typos / Grammar</option>
            <option value="Other">Other Issue</option>
        </select>
        <textarea id="reportDesc" placeholder="Describe here..." rows="3"></textarea>
        <button onclick="submitReport()" style="background:#e11d48;">SEND REPORT üöÄ</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getDatabase, ref, get, set, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBOVvfW63xx10C4_l9obcQMC64cDFGndZ8",
        authDomain: "smart-quiz-system-d59d9.firebaseapp.com",
        databaseURL: "https://smart-quiz-system-d59d9-default-rtdb.firebaseio.com",
        projectId: "smart-quiz-system-d59d9",
        storageBucket: "smart-quiz-system-d59d9.firebasestorage.app",
        messagingSenderId: "38603211706",
        appId: "1:38603211706:web:57b1e7a3d48426544ad383"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    let examData = null;
    let currentTeacher = "";
    let cheated = false;
    let timeLeft = 600;

    window.attemptEntry = async () => {
        const email = document.getElementById('sEmail').value;
        const pass = document.getElementById('sPass').value;
        const tID = document.getElementById('teacherID').value.trim().toLowerCase();
        const reg = document.getElementById('studentReg').value.trim();

        if(!email || !pass || !tID || !reg) return alert("All fields required!");

        try {
            const snapshot = await get(ref(db, 'exams/' + tID));
            if (!snapshot.exists()) return alert("Exam not found!");
            
            examData = snapshot.val();
            currentTeacher = tID;

            if(!examData.allowedList.includes(reg)) return alert("Roll Number not authorized!");

            await signInWithEmailAndPassword(auth, email, pass).catch(() => {
                return createUserWithEmailAndPassword(auth, email, pass);
            });

            document.getElementById('loginArea').style.display = 'none';
            document.getElementById('quizArea').style.display = 'block';
            loadQuestions();
            startTimer();
        } catch (e) { alert(e.message); }
    };

    function loadQuestions() {
        const container = document.getElementById('questionContent');
        container.innerHTML = "";
        examData.questions.forEach((q, i) => {
            let html = `<div class="q-block"><h3>Q${i+1}: ${q.text}</h3>`;
            if(q.type === 'mcq') {
                for(let key in q.options) {
                    html += `<label class="opt-label"><input type="radio" name="q${i}" value="${key}"> ${key}: ${q.options[key]}</label>`;
                }
            } else {
                html += `<textarea id="ans${i}" placeholder="Write answer..." style="height:80px;"></textarea>`;
            }
            container.innerHTML += html + `</div>`;
        });
    }

    function startTimer() {
        const timerObj = setInterval(() => {
            timeLeft--;
            let mins = Math.floor(timeLeft / 60);
            let secs = timeLeft % 60;
            document.getElementById('timerDisplay').innerText = `Time Left: ${mins}:${secs < 10 ? '0' : ''}${secs}`;
            if(timeLeft <= 0) { clearInterval(timerObj); submitExam(); }
        }, 1000);
    }

    window.onblur = () => { cheated = true; };

    window.submitExam = async () => {
        const reg = document.getElementById('studentReg').value;
        let score = 0;

        examData.questions.forEach((q, i) => {
            if(q.type === 'mcq') {
                const selected = document.querySelector(`input[name="q${i}"]:checked`)?.value;
                if(selected === q.correct) score++;
            }
            // Subjective logic: score stays 0 for manual grading later
        });

        const finalScore = Math.round((score / examData.questions.length) * 100);

        await set(ref(db, `exams/${currentTeacher}/submissions/${reg}`), {
            name: reg, score: finalScore, cheated: cheated, time: new Date().toLocaleTimeString()
        });

        alert("Test Submitted!");
        location.reload();
    };

    // Hafsa's Reporting Functions
    window.toggleModal = (show) => { document.getElementById('reportModal').style.display = show ? 'flex' : 'none'; };

    window.submitReport = async () => {
        const qNum = document.getElementById('reportQNum').value;
        const reason = document.getElementById('reportReason').value;
        const desc = document.getElementById('reportDesc').value;
        
        if (!qNum || !reason || !desc) return alert("Fill all report fields!");

        await push(ref(db, `reports/${currentTeacher}`), {
            student: document.getElementById('studentReg').value,
            questionNumber: qNum,
            reason: reason,
            description: desc,
            timestamp: new Date().toISOString()
        });
        alert("Report Sent!");
        window.toggleModal(false);
    };
</script>

<script>
    // Laiba's Theme Switcher Logic
    const themeBtn = document.getElementById("themeBtn");
    if(localStorage.getItem("theme")==="dark"){
        document.documentElement.setAttribute("data-theme","dark");
        themeBtn.innerText = "‚òÄÔ∏è Light Mode";
    }

    themeBtn.addEventListener("click", ()=>{
        let current = document.documentElement.getAttribute("data-theme");
        if(current==="dark"){
            document.documentElement.removeAttribute("data-theme");
            localStorage.setItem("theme","light");
            themeBtn.innerText = "üåô Dark Mode";
        } else {
            document.documentElement.setAttribute("data-theme","dark");
            localStorage.setItem("theme","dark");
            themeBtn.innerText = "‚òÄÔ∏è Light Mode";
        }
    });
</script>
</body>
</html>
