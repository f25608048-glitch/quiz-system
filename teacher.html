<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Teacher Portal - Full Options</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #0f172a; color: white; margin: 0; min-height: 100vh; display: flex; justify-content: center; align-items: center; }
        #authScreen { background: #1e293b; padding: 40px; border-radius: 15px; width: 320px; text-align: center; }
        .container { max-width: 1100px; margin: 20px; display: none; gap: 20px; width: 95%; flex-wrap: wrap; align-items: flex-start; }
        .box { background: #1e293b; padding: 25px; border-radius: 12px; flex: 1; min-width: 320px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; border-radius: 6px; border: none; background: #f1f5f9; color: #0f172a; }
        button { background: #3b82f6; color: white; border: none; padding: 14px; border-radius: 6px; cursor: pointer; width: 100%; font-weight: bold; margin-top: 10px; }
        .q-item { background: #0f172a; padding: 10px; margin: 5px 0; border-radius: 5px; border-left: 4px solid #10b981; font-size: 0.9rem; }
        .mcq-box { background: #334155; padding: 10px; border-radius: 8px; margin-top: 10px; display: none; }
    </style>
</head>
<body>

<div id="authScreen">
    <h2 id="authTitle">Teacher Access</h2>
    <input type="email" id="tEmail" placeholder="Gmail Address">
    <input type="text" id="tUser" placeholder="Username (Unique ID)">
    <input type="password" id="tPass" placeholder="Password">
    <button onclick="handleAuth()" id="authBtn">Login / Sign Up</button>
</div>

<div class="container" id="dashboard">
    <div class="box">
        <h2 id="welcomeMsg">Welcome</h2>
        <h3>1. Setup Exam</h3>
        <textarea id="rollList" placeholder="Allowed Rolls (e.g. 101, 102)"></textarea>
        
        <h3>2. Add Questions</h3>
        <select id="qType" onchange="toggleFields()">
            <option value="subjective">Subjective Question</option>
            <option value="mcq">MCQ (Multiple Choice)</option>
        </select>
        
        <input type="text" id="qText" placeholder="Enter Question Statement">
        
        <div id="mcqBox" class="mcq-box">
            <input type="text" id="optA" placeholder="Option A">
            <input type="text" id="optB" placeholder="Option B">
            <input type="text" id="optC" placeholder="Option C">
            <input type="text" id="optD" placeholder="Option D">
            <select id="correctOpt">
                <option value="A">Correct: A</option>
                <option value="B">Correct: B</option>
                <option value="C">Correct: C</option>
                <option value="D">Correct: D</option>
            </select>
        </div>
        
        <button onclick="addQuestion()" style="background:#6366f1;">Add to Paper ‚ûï</button>
        <div id="preview" style="margin-top:15px;"></div>
        <button onclick="publish()" style="background:#10b981; margin-top:20px;">Publish Exam üöÄ</button>
    </div>

    <div class="box" style="max-width: 350px;">
        <h3>üìä Live Results</h3>
        <input 
            type="text" 
            id="rollSearch" 
            placeholder="üîç Search Roll Number"
            oninput="filterResults()"
            style="margin-bottom:10px;"
        >

        <div id="resList">No submissions yet.</div>
        <button onclick="location.reload()" style="background:#ef4444; margin-top:30px;">Logout</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getDatabase, ref, set, get, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBOVvfW63xx10C4_l9obcQMC64cDFGndZ8",
        authDomain: "smart-quiz-system-d59d9.firebaseapp.com",
        databaseURL: "https://smart-quiz-system-d59d9-default-rtdb.firebaseio.com",
        projectId: "smart-quiz-system-d59d9",
        storageBucket: "smart-quiz-system-d59d9.firebasestorage.app",
        messagingSenderId: "38603211706",
        appId: "1:38603211706:web:57b1e7a3d48426544ad383"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    let currentID = "";
    let paper = [];

    
    let allSubmissions = {};

    window.toggleFields = () => {
        const type = document.getElementById('qType').value;
        document.getElementById('mcqBox').style.display = (type === 'mcq') ? 'block' : 'none';
    };

    window.handleAuth = () => {
        const email = document.getElementById('tEmail').value;
        const pass = document.getElementById('tPass').value;
        const user = document.getElementById('tUser').value.trim().toLowerCase();

        signInWithEmailAndPassword(auth, email, pass)
            .then(() => startDash(user))
            .catch(() => {
                createUserWithEmailAndPassword(auth, email, pass)
                    .then(() => {
                        set(ref(db, 'teachers/' + user), { email });
                        startDash(user);
                    })
                    .catch(e => alert(e.message));
            });
    };

    function startDash(user) {
        currentID = user;
        document.getElementById('authScreen').style.display = "none";
        document.getElementById('dashboard').style.display = "flex";
        document.getElementById('welcomeMsg').innerText = "ID: " + user;

        
        onValue(ref(db, 'exams/' + user + '/submissions'), (snap) => {
            if(snap.exists()) {
                allSubmissions = snap.val();
                renderResults(allSubmissions);
            } else {
                document.getElementById('resList').innerHTML = "No submissions yet.";
            }
        });
    }

    
    window.renderResults = (data) => {
        const list = document.getElementById('resList');
        list.innerHTML = "";

        const entries = Object.entries(data);

        if(entries.length === 0) {
            list.innerHTML = "No matching results.";
            return;
        }

        entries.forEach(([roll, s]) => {
            list.innerHTML += `
                <div class='q-item'>
                    ${roll}: ${s.score}% ${s.cheated ? '‚ö†Ô∏è' : '‚úÖ'}
                </div>`;
        });
    };

    window.filterResults = () => {
        const query = document.getElementById('rollSearch').value.toLowerCase();

        if(!query) {
            renderResults(allSubmissions);
            return;
        }

        const filtered = Object.fromEntries(
            Object.entries(allSubmissions).filter(([roll]) =>
                roll.toLowerCase().includes(query)
            )
        );

        renderResults(filtered);
    };

    window.addQuestion = () => {
        const type = document.getElementById('qType').value;
        const text = document.getElementById('qText').value;
        
        if(!text) return alert("Sawal to likhein pehle!");

        let qObj = { type, text };

        if(type === 'mcq') {
            qObj.options = {
                A: document.getElementById('optA').value,
                B: document.getElementById('optB').value,
                C: document.getElementById('optC').value,
                D: document.getElementById('optD').value
            };
            qObj.correct = document.getElementById('correctOpt').value;
        }

        paper.push(qObj);
        document.getElementById('preview').innerHTML += `<div class='q-item'>${text} (${type})</div>`;
        document.getElementById('qText').value = ""; 

        if(type === 'mcq') {
            optA.value = optB.value = optC.value = optD.value = "";
        }
    };

    window.publish = () => {
        const rolls = document.getElementById('rollList').value.split(',').map(r => r.trim());
        if(paper.length === 0) return alert("Kam se kam aik sawal to dalein!");
        
        set(ref(db, 'exams/' + currentID), { 
            questions: paper, 
            allowedList: rolls,
            publishedAt: Date.now()
        }).then(() => alert("Exam is now LIVE! Students can join using your ID."));
    };
</script>
</body>
</html>

