<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Portal - User Management</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .login-container {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 400px;
        }

        .admin-panel {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 1400px;
            display: none;
            padding: 30px;
        }

        h1 {
            color: #667eea;
            margin-bottom: 10px;
            text-align: center;
        }

        h2 {
            color: #333;
            margin-bottom: 20px;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 0.9rem;
        }

        input[type="text"],
        input[type="password"],
        input[type="email"] {
            width: 100%;
            padding: 12px 15px;
            margin: 10px 0;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            width: 100%;
            padding: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
            margin-top: 10px;
        }

        button:hover {
            background: #5568d3;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #eee;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 2rem;
            margin-bottom: 5px;
        }

        .stat-card p {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
        }

        .tab {
            padding: 12px 24px;
            background: transparent;
            color: #666;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            width: auto;
            margin-top: 0;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .user-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .user-table thead {
            background: #667eea;
            color: white;
        }

        .user-table th,
        .user-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .user-table tbody tr:hover {
            background: #f8f9ff;
        }

        .action-btn {
            padding: 6px 12px;
            margin: 0 3px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            font-size: 0.85rem;
            width: auto;
            margin-top: 0;
        }

        .edit-btn {
            background: #3b82f6;
            color: white;
        }

        .delete-btn {
            background: #ef4444;
            color: white;
        }

        .logout-btn {
            background: #ef4444;
            padding: 10px 24px;
            width: auto;
            margin-top: 0;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-content h2 {
            margin-bottom: 20px;
        }

        .close-modal {
            background: #999;
            margin-top: 15px;
        }

        .search-bar {
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 15px;
            opacity: 0.3;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-teacher {
            background: #dbeafe;
            color: #1e40af;
        }

        .badge-student {
            background: #dcfce7;
            color: #166534;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 600;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .stats {
                grid-template-columns: 1fr;
            }

            .user-table {
                font-size: 0.85rem;
            }

            .action-btn {
                padding: 4px 8px;
                font-size: 0.75rem;
            }
        }
    </style>
</head>

<body>
    <!-- Login Screen -->
    <div class="login-container" id="loginScreen">
        <h1>üîê Admin Portal</h1>
        <p class="subtitle">Secure Access Only</p>
        <input type="text" id="adminUser" placeholder="Admin Username">
        <input type="password" id="adminPass" placeholder="Admin Password">
        <button onclick="adminLogin()">Login</button>
    </div>

    <!-- Admin Panel -->
    <div class="admin-panel" id="adminPanel">
        <div class="header">
            <div>
                <h1>üë®‚Äçüíº Admin Dashboard</h1>
                <p class="subtitle">Manage all users and credentials</p>
            </div>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>

        <div class="stats">
            <div class="stat-card">
                <h3 id="teacherCount">0</h3>
                <p>Total Teachers</p>
            </div>
            <div class="stat-card">
                <h3 id="studentCount">0</h3>
                <p>Total Students</p>
            </div>
            <div class="stat-card">
                <h3 id="totalCount">0</h3>
                <p>Total Users</p>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('teachers')">üë®‚Äçüè´ Teachers</button>
            <button class="tab" onclick="switchTab('students')">üë®‚Äçüéì Students</button>
            <button class="tab" onclick="switchTab('all')">üìã All Users</button>
        </div>

        <!-- Teachers Tab -->
        <div class="tab-content active" id="teachers-tab">
            <h2>Teacher Accounts</h2>
            <input type="text" class="search-bar" id="teacherSearch" placeholder="üîç Search teachers..."
                oninput="filterTable('teacherSearch', 'teacherTable')">
            <button onclick="showAddModal('teacher')" style="width: 200px; margin-bottom: 20px;">+ Add New
                Teacher</button>
            <table class="user-table" id="teacherTable">
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>Email</th>
                        <th>Password</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="teacherTableBody">
                    <tr>
                        <td colspan="4" class="empty-state">No teachers found</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Students Tab -->
        <div class="tab-content" id="students-tab">
            <h2>Student Accounts</h2>
            <input type="text" class="search-bar" id="studentSearch" placeholder="üîç Search students..."
                oninput="filterTable('studentSearch', 'studentTable')">
            <button onclick="showAddModal('student')" style="width: 200px; margin-bottom: 20px;">+ Add New
                Student</button>
            <table class="user-table" id="studentTable">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Password</th>
                        <th>Roll Number</th>
                        <th>Teacher ID</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="studentTableBody">
                    <tr>
                        <td colspan="6" class="empty-state">No students found</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- All Users Tab -->
        <div class="tab-content" id="all-tab">
            <h2>All Users</h2>
            <input type="text" class="search-bar" id="allSearch" placeholder="üîç Search all users..."
                oninput="filterTable('allSearch', 'allTable')">
            <table class="user-table" id="allTable">
                <thead>
                    <tr>
                        <th>Type</th>
                        <th>Name/Username</th>
                        <th>Email</th>
                        <th>Password</th>
                        <th>Extra Info</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="allTableBody">
                    <tr>
                        <td colspan="6" class="empty-state">No users found</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Add/Edit Modal -->
    <div class="modal" id="userModal">
        <div class="modal-content">
            <h2 id="modalTitle">Add User</h2>
            <div id="modalForm"></div>
            <button onclick="saveUser()">Save</button>
            <button class="close-modal" onclick="closeModal()">Cancel</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, get, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBOVvfW63xx10C4_l9obcQMC64cDFGndZ8",
            authDomain: "smart-quiz-system-d59d9.firebaseapp.com",
            databaseURL: "https://smart-quiz-system-d59d9-default-rtdb.firebaseio.com",
            projectId: "smart-quiz-system-d59d9",
            storageBucket: "smart-quiz-system-d59d9.firebasestorage.app",
            messagingSenderId: "38603211706",
            appId: "1:38603211706:web:57b1e7a3d48426544ad383"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        window.db = db;
        window.auth = auth;

        let currentEditUser = null;
        let currentUserType = null;

        // Admin credentials (in production, store these securely!)
        const ADMIN_USERNAME = "admin";
        const ADMIN_PASSWORD = "admin123";

        window.adminLogin = () => {
            const username = document.getElementById('adminUser').value;
            const password = document.getElementById('adminPass').value;

            if (username === ADMIN_USERNAME && password === ADMIN_PASSWORD) {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('adminPanel').style.display = 'block';
                loadAllData();
            } else {
                alert('Invalid credentials!');
            }
        };

        window.logout = () => {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('adminPanel').style.display = 'none';
            document.getElementById('adminUser').value = '';
            document.getElementById('adminPass').value = '';
        };

        window.switchTab = (tab) => {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(tab + '-tab').classList.add('active');
        };

        async function loadAllData() {
            // Load teachers
            const teachersRef = ref(db, 'teachers');
            onValue(teachersRef, (snapshot) => {
                const teachers = snapshot.val() || {};
                displayTeachers(teachers);
                updateStats();
            });

            // Load students from multiple sources
            await loadAllStudents();
        }

        async function loadAllStudents() {
            let allStudents = {};

            // Source 1: student-logins (students who logged in)
            const studentLoginsSnapshot = await get(ref(db, 'student-logins'));
            const studentLogins = studentLoginsSnapshot.val() || {};
            
            // Flatten the nested structure: student-logins/{teacherID}/{rollNumber}
            Object.entries(studentLogins).forEach(([teacherID, students]) => {
                Object.entries(students).forEach(([rollNumber, data]) => {
                    const key = `${teacherID}_${rollNumber}`;
                    allStudents[key] = {
                        ...data,
                        teacherID: teacherID,
                        rollNumber: rollNumber,
                        source: 'login'
                    };
                });
            });

            // Source 2: exam submissions (students who submitted exams)
            const examsSnapshot = await get(ref(db, 'exams'));
            const exams = examsSnapshot.val() || {};
            
            Object.entries(exams).forEach(([teacherID, examData]) => {
                if (examData.submissions) {
                    Object.entries(examData.submissions).forEach(([rollNumber, submission]) => {
                        const key = `${teacherID}_${rollNumber}`;
                        // If student doesn't exist or only has login data, add/update with submission data
                        if (!allStudents[key]) {
                            allStudents[key] = {
                                name: submission.name || rollNumber,
                                email: 'N/A',
                                rollNumber: rollNumber,
                                teacherID: teacherID,
                                password: '',
                                source: 'submission'
                            };
                        } else if (allStudents[key].source === 'login') {
                            // Merge login data with submission name if available
                            allStudents[key].name = submission.name || allStudents[key].name;
                        }
                    });
                }
            });

            displayStudents(allStudents);
            updateStats();

            // Set up real-time listener for future changes
            onValue(ref(db, 'student-logins'), () => loadAllStudents());
        }

        function displayTeachers(teachers) {
            const tbody = document.getElementById('teacherTableBody');
            tbody.innerHTML = '';

            if (Object.keys(teachers).length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="empty-state">No teachers found</td></tr>';
                return;
            }

            Object.entries(teachers).forEach(([username, data]) => {
                const row = `
                    <tr>
                        <td><strong>${username}</strong></td>
                        <td>${data.email || 'N/A'}</td>
                        <td>${data.password || '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢'}</td>
                        <td>
                            <button class="action-btn edit-btn" onclick="editUser('teacher', '${username}')">Edit</button>
                            <button class="action-btn delete-btn" onclick="deleteUser('teacher', '${username}')">Delete</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });

            // Update all users table
            updateAllUsersTable();
        }

        function displayStudents(students) {
            const tbody = document.getElementById('studentTableBody');
            tbody.innerHTML = '';

            if (Object.keys(students).length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No students found</td></tr>';
                return;
            }

            Object.entries(students).forEach(([key, data]) => {
                const row = `
                    <tr>
                        <td>${data.name || 'N/A'}</td>
                        <td>${data.email || 'N/A'}</td>
                        <td>${data.password || '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢'}</td>
                        <td>${data.rollNumber || 'N/A'}</td>
                        <td>${data.teacherID || 'N/A'}</td>
                        <td>
                            <button class="action-btn edit-btn" onclick="editUser('student', '${key}')">Edit</button>
                            <button class="action-btn delete-btn" onclick="deleteUser('student', '${key}')">Delete</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });

            // Update all users table
            updateAllUsersTable();
        }

        async function updateAllUsersTable() {
            const tbody = document.getElementById('allTableBody');
            tbody.innerHTML = '';

            // Get teachers
            const teachersSnapshot = await get(ref(db, 'teachers'));
            const teachers = teachersSnapshot.val() || {};

            // Get students from both sources
            let allStudents = {};
            
            const studentLoginsSnapshot = await get(ref(db, 'student-logins'));
            const studentLogins = studentLoginsSnapshot.val() || {};
            
            Object.entries(studentLogins).forEach(([teacherID, students]) => {
                Object.entries(students).forEach(([rollNumber, data]) => {
                    const key = `${teacherID}_${rollNumber}`;
                    allStudents[key] = {
                        ...data,
                        teacherID: teacherID,
                        rollNumber: rollNumber
                    };
                });
            });

            // Also get from exam submissions
            const examsSnapshot = await get(ref(db, 'exams'));
            const exams = examsSnapshot.val() || {};
            
            Object.entries(exams).forEach(([teacherID, examData]) => {
                if (examData.submissions) {
                    Object.entries(examData.submissions).forEach(([rollNumber, submission]) => {
                        const key = `${teacherID}_${rollNumber}`;
                        if (!allStudents[key]) {
                            allStudents[key] = {
                                name: submission.name || rollNumber,
                                email: 'N/A',
                                rollNumber: rollNumber,
                                teacherID: teacherID,
                                password: ''
                            };
                        }
                    });
                }
            });

            if (Object.keys(teachers).length === 0 && Object.keys(allStudents).length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No users found</td></tr>';
                return;
            }

            // Add teachers
            Object.entries(teachers).forEach(([username, data]) => {
                const row = `
                    <tr>
                        <td><span class="badge badge-teacher">Teacher</span></td>
                        <td><strong>${username}</strong></td>
                        <td>${data.email || 'N/A'}</td>
                        <td>${data.password || '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢'}</td>
                        <td>-</td>
                        <td>
                            <button class="action-btn edit-btn" onclick="editUser('teacher', '${username}')">Edit</button>
                            <button class="action-btn delete-btn" onclick="deleteUser('teacher', '${username}')">Delete</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });

            // Add students
            Object.entries(allStudents).forEach(([key, data]) => {
                const row = `
                    <tr>
                        <td><span class="badge badge-student">Student</span></td>
                        <td>${data.name || 'N/A'}</td>
                        <td>${data.email || 'N/A'}</td>
                        <td>${data.password || '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢'}</td>
                        <td>Roll: ${data.rollNumber || 'N/A'}</td>
                        <td>
                            <button class="action-btn edit-btn" onclick="editUser('student', '${key}')">Edit</button>
                            <button class="action-btn delete-btn" onclick="deleteUser('student', '${key}')">Delete</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        async function updateStats() {
            const teachersSnapshot = await get(ref(db, 'teachers'));
            
            // Count students from both sources
            let studentCount = 0;
            
            // Count from student-logins
            const studentLoginsSnapshot = await get(ref(db, 'student-logins'));
            const studentLogins = studentLoginsSnapshot.val() || {};
            Object.values(studentLogins).forEach(teacherStudents => {
                studentCount += Object.keys(teacherStudents || {}).length;
            });

            // Also check exam submissions for any additional students
            const examsSnapshot = await get(ref(db, 'exams'));
            const exams = examsSnapshot.val() || {};
            const uniqueStudents = new Set();
            
            Object.entries(exams).forEach(([teacherID, examData]) => {
                if (examData.submissions) {
                    Object.keys(examData.submissions).forEach(rollNumber => {
                        uniqueStudents.add(`${teacherID}_${rollNumber}`);
                    });
                }
            });

            // Use the higher count
            studentCount = Math.max(studentCount, uniqueStudents.size);

            const teacherCount = Object.keys(teachersSnapshot.val() || {}).length;

            document.getElementById('teacherCount').textContent = teacherCount;
            document.getElementById('studentCount').textContent = studentCount;
            document.getElementById('totalCount').textContent = teacherCount + studentCount;
        }

        window.showAddModal = (type) => {
            currentEditUser = null;
            currentUserType = type;
            document.getElementById('modalTitle').textContent = `Add New ${type === 'teacher' ? 'Teacher' : 'Student'}`;

            const form = document.getElementById('modalForm');
            if (type === 'teacher') {
                form.innerHTML = `
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" id="edit-username" placeholder="Enter unique username">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="edit-email" placeholder="teacher@example.com">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="text" id="edit-password" placeholder="Enter password">
                    </div>
                `;
            } else {
                form.innerHTML = `
                    <div class="form-group">
                        <label>Full Name</label>
                        <input type="text" id="edit-name" placeholder="Enter student name">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="edit-email" placeholder="student@example.com">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="text" id="edit-password" placeholder="Enter password (6+ chars)">
                    </div>
                    <div class="form-group">
                        <label>Roll Number</label>
                        <input type="text" id="edit-roll" placeholder="Enter roll number">
                    </div>
                    <div class="form-group">
                        <label>Teacher ID</label>
                        <input type="text" id="edit-teacherID" placeholder="Enter teacher's username">
                    </div>
                `;
            }

            document.getElementById('userModal').style.display = 'flex';
        };

        window.editUser = async (type, key) => {
            currentEditUser = key;
            currentUserType = type;
            document.getElementById('modalTitle').textContent = `Edit ${type === 'teacher' ? 'Teacher' : 'Student'}`;

            if (type === 'teacher') {
                // Get teacher data
                const snapshot = await get(ref(db, `teachers/${key}`));
                const data = snapshot.val();

                const form = document.getElementById('modalForm');
                form.innerHTML = `
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" id="edit-username" value="${key}" readonly style="background: #f0f0f0;">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="edit-email" value="${data.email || ''}">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="text" id="edit-password" value="${data.password || ''}" placeholder="Leave blank to keep current">
                    </div>
                `;
            } else {
                // For students, key format is: teacherID_rollNumber
                const [teacherID, rollNumber] = key.split('_');
                
                // Try to get student data from student-logins
                const snapshot = await get(ref(db, `student-logins/${teacherID}/${rollNumber}`));
                let data = snapshot.val() || {};
                
                // If not found in student-logins, try exam submissions
                if (!data || Object.keys(data).length === 0) {
                    const examSnapshot = await get(ref(db, `exams/${teacherID}/submissions/${rollNumber}`));
                    const examData = examSnapshot.val() || {};
                    data = {
                        name: examData.name || rollNumber,
                        email: 'N/A',
                        rollNumber: rollNumber,
                        teacherID: teacherID,
                        password: ''
                    };
                }

                const form = document.getElementById('modalForm');
                form.innerHTML = `
                    <div class="form-group">
                        <label>Full Name</label>
                        <input type="text" id="edit-name" value="${data.name || ''}">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="edit-email" value="${data.email || ''}">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="text" id="edit-password" value="${data.password || ''}" placeholder="Leave blank to keep current">
                    </div>
                    <div class="form-group">
                        <label>Roll Number</label>
                        <input type="text" id="edit-roll" value="${rollNumber || data.rollNumber || ''}" readonly style="background: #f0f0f0;">
                    </div>
                    <div class="form-group">
                        <label>Teacher ID</label>
                        <input type="text" id="edit-teacherID" value="${teacherID || data.teacherID || ''}" readonly style="background: #f0f0f0;">
                    </div>
                `;
            }

            document.getElementById('userModal').style.display = 'flex';
        };

        window.saveUser = async () => {
            if (currentUserType === 'teacher') {
                const username = document.getElementById('edit-username').value.trim();
                const email = document.getElementById('edit-email').value.trim();
                const password = document.getElementById('edit-password').value.trim();

                if (!username || !email) {
                    alert('Username and email are required!');
                    return;
                }

                const userData = { email };
                if (password) userData.password = password;

                await set(ref(db, `teachers/${username}`), userData);
                alert('Teacher saved successfully!');
            } else {
                const name = document.getElementById('edit-name').value.trim();
                const email = document.getElementById('edit-email').value.trim();
                const password = document.getElementById('edit-password').value.trim();
                const roll = document.getElementById('edit-roll').value.trim();
                const teacherID = document.getElementById('edit-teacherID').value.trim();

                if (!name || !email || !roll || !teacherID) {
                    alert('All fields are required!');
                    return;
                }

                const userData = { 
                    name, 
                    email, 
                    rollNumber: roll, 
                    teacherID,
                    loginTime: new Date().toISOString(),
                    loginDate: new Date().toLocaleDateString(),
                    loginTimeFormatted: new Date().toLocaleString()
                };
                if (password) userData.password = password;

                // Save to student-logins/{teacherID}/{rollNumber}
                await set(ref(db, `student-logins/${teacherID}/${roll}`), userData);
                alert('Student saved successfully!');
            }

            closeModal();
            await loadAllStudents();
            updateAllUsersTable();
        };

        window.deleteUser = async (type, key) => {
            if (!confirm(`Are you sure you want to delete this ${type}?`)) return;

            if (type === 'teacher') {
                await remove(ref(db, `teachers/${key}`));
            } else {
                // For students, key format is: teacherID_rollNumber
                const [teacherID, rollNumber] = key.split('_');
                await remove(ref(db, `student-logins/${teacherID}/${rollNumber}`));
            }
            
            alert(`${type === 'teacher' ? 'Teacher' : 'Student'} deleted successfully!`);
            await loadAllStudents();
            updateAllUsersTable();
        };

        window.closeModal = () => {
            document.getElementById('userModal').style.display = 'none';
        };

        window.filterTable = (searchId, tableId) => {
            const searchValue = document.getElementById(searchId).value.toLowerCase();
            const table = document.getElementById(tableId);
            const rows = table.getElementsByTagName('tr');

            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchValue) ? '' : 'none';
            }
        };

        // Make functions available globally
        window.loadAllData = loadAllData;
        window.displayTeachers = displayTeachers;
        window.displayStudents = displayStudents;
    </script>
</body>

</html>
